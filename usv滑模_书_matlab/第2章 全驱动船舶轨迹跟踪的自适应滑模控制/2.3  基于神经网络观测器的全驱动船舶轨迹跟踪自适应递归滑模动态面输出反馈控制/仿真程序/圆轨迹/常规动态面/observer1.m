function [sys,x0,str,ts]=chap4_3guance(t,x,u,flag)
switch flag,
case 0,
    [sys,x0,str,ts]=mdlInitializeSizes;
case 1,
    sys=mdlDerivatives(t,x,u);
case 3,
    sys=mdlOutputs(t,x,u);
case {2, 4, 9 }
    sys = [];
otherwise
    error(['Unhandled flag = ',num2str(flag)]);
end
function [sys,x0,str,ts]=mdlInitializeSizes
sizes = simsizes;
sizes.NumContStates  = 183;
sizes.NumDiscStates  = 0;
sizes.NumOutputs     = 15;
sizes.NumInputs      = 15;
sizes.DirFeedthrough = 1;
sizes.NumSampleTimes = 1;
sys = simsizes(sizes);
x0  = 0*ones(1,183);
% x0  = [];
str = [];
ts  = [0 0];
global bo Lo
% L1o=20*[-30 -29 -28 -27 -26 -25 -24 -23 -22 -21 -20 -19 -18 -17 -16 -15 -14 -13 -12 -11 -10 -9 -8 -7 -6 -5 -4 -3 -2 -1 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30];
% L2o=20*[0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60];
% L3o=[0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60];
Lo=[-30 -29 -28 -27 -26 -25 -24 -23 -22 -21 -20 -19 -18 -17 -16 -15 -14 -13 -12 -11 -10 -9 -8 -7 -6 -5 -4 -3 -2 -1 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30;
   -30 -29 -28 -27 -26 -25 -24 -23 -22 -21 -20 -19 -18 -17 -16 -15 -14 -13 -12 -11 -10 -9 -8 -7 -6 -5 -4 -3 -2 -1 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30;
   -30 -29 -28 -27 -26 -25 -24 -23 -22 -21 -20 -19 -18 -17 -16 -15 -14 -13 -12 -11 -10 -9 -8 -7 -6 -5 -4 -3 -2 -1 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30];
%    -30 -29 -28 -27 -26 -25 -24 -23 -22 -21 -20 -19 -18 -17 -16 -15 -14 -13 -12 -11 -10 -9 -8 -7 -6 -5 -4 -3 -2 -1 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30;
%    -30 -29 -28 -27 -26 -25 -24 -23 -22 -21 -20 -19 -18 -17 -16 -15 -14 -13 -12 -11 -10 -9 -8 -7 -6 -5 -4 -3 -2 -1 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30];
% Lo=[L1o;L2o;L3o];
bo=3;


function sys=mdlDerivatives(~,x,u)
global bo Lo 

xx=u(1);
y=u(2);
psi=u(3);
ETA=[xx;y;psi];
ETAG=[u(7);u(8);u(9)];
VG=[u(10);u(11);u(12)];
VV=[u(13);u(14);u(15)];
ut=u(13);
v=u(14);
r=u(15);
ETAE=ETAG-ETA;

tau1=u(4);
tau2=u(5);
tau3=u(6);
% Zo=[xx;y;psi;tau1;tau2;tau3];
Zo=[xx;y;psi];
ho=zeros(61,1);
for j=1:1:61
    ho(j)=exp(-norm(Zo-Lo(:,j))^2/(2*bo^2));
end
HHo=[ho;ho;ho];

gama1o=1*10;bb1o=1;
for i=1:1:61
    W1o=x(i);
    sys(i)=gama1o*(-HHo(i)*ETAE(1)-bb1o*W1o);
end
gama2o=1*10;bb2o=1;
for i=62:1:122
    W2o=x(i);
    sys(i)=gama2o*(-HHo(i)*ETAE(2)-bb2o*W2o);
end
gama3o=1*10;bb3o=1;
for i=123:1:183
    W3o=x(i);
    sys(i)=gama3o*(-HHo(i)*ETAE(3)-bb3o*W3o);
end

function sys=mdlOutputs(t,x,u)
global bo Lo 
xx=u(1);
y=u(2);
psi=u(3);
ETA=[xx;y;psi];
tau1=u(4);
tau2=u(5);
tau3=u(6);
TAU=[u(4);u(5);u(6)];
ETAG=[u(7);u(8);u(9)];
VG=[u(10);u(11);u(12)];
ut=u(13);
v=u(14);
r=u(15);
VV=[u(13);u(14);u(15)];
ETAE=ETAG-ETA;

W1o=[x(1) x(2) x(3) x(4) x(5) x(6) x(7) x(8) x(9) x(10) x(11) x(12) x(13) x(14) x(15) x(16) x(17) x(18) x(19) x(20) x(21) x(22) x(23) x(24) x(25) x(26) x(27) x(28) x(29) x(30) x(31) x(32) x(33) x(34) x(35) x(36) x(37) x(38) x(39) x(40) x(41) x(42) x(43) x(44) x(45) x(46) x(47) x(48) x(49) x(50) x(51) x(52) x(53) x(54) x(55) x(56) x(57) x(58) x(59) x(60) x(61)];
W2o=[x(62) x(63) x(64) x(65) x(66) x(67) x(68) x(69) x(70) x(71) x(72) x(73) x(74) x(75) x(76) x(77) x(78) x(79) x(80) x(81) x(82) x(83) x(84) x(85) x(86) x(87) x(88) x(89) x(90) x(91) x(92) x(93) x(94) x(95) x(96) x(97) x(98) x(99) x(100) x(101) x(102) x(103) x(104) x(105) x(106) x(107) x(108) x(109) x(110) x(111) x(112) x(113) x(114) x(115) x(116) x(117) x(118) x(119) x(120) x(121) x(122)];
W3o=[x(123) x(124) x(125) x(126) x(127) x(128) x(129) x(130) x(131) x(132) x(133) x(134) x(135) x(136) x(137) x(138) x(139) x(140) x(141) x(142) x(143) x(144) x(145) x(146) x(147) x(148) x(149) x(150) x(151) x(152) x(153) x(154) x(155) x(156) x(157) x(158) x(159) x(160) x(161) x(162) x(163) x(164) x(165) x(166) x(167) x(168) x(169) x(170) x(171) x(172) x(173) x(174) x(175) x(176) x(177) x(178) x(179) x(180) x(181) x(182) x(183)];

% Zo=[xx;y;psi;tau1;tau2;tau3];
Zo=[xx;y;psi];
ho=zeros(61,1);
for j=1:1:61
    ho(j)=exp(-norm(Zo-Lo(:,j))^2/(2*bo^2));
end
HHo=[ho;ho;ho];

m11=5.3122*10^6;
m22=8.2831*10^6;
m23=0;
m33=3.7454*10^9;
M=[5.3122*10^6 0 0;0 8.2831*10^6 0;0 0 3.7454*10^9];
C=[0 0 -m22*v-m23*r;0 0 m11*ut;m22*v+m23*r -m11*ut 0];
du=5.0242*10^4;
dv=2.7229*10^5;
dr=4.1894*10^8;
D=[5.0242*10^4 0 0;0 2.7229*10^5 -4.3933*10^6;0 -4.3933*10^6 4.1894*10^8];
DDD=[1*10^5*(sin(0.2*t)+cos(0.5*t));1*10^5*(sin(0.1*t)+cos(0.4*t));1*10^6*(sin(0.5*t)+cos(0.3*t))];
J=[cos(psi) -sin(psi) 0;sin(psi) cos(psi) 0;0 0 1];
JT=[cos(psi) sin(psi) 0;-sin(psi) cos(psi) 0;0 0 1];
JdT=[-r*sin(psi) r*cos(psi) 0;-r*cos(psi) -r*sin(psi) 0;0 0 0];
K3o=diag([1,1,1]);
Fos=M\(TAU+DDD-C*VV-D*VV)+K3o*JdT*ETAE;
f1o=W1o*ho;
f2o=W2o*ho;
f3o=W3o*ho;
Fog=[f1o;f2o;f3o];
K1o=diag([1,1,1]);
K2o=diag([5,5,5]);
dX1=J*VG-K1o*ETAE;
dX2=Fog-K2o*JT*ETAE;

sys(1)=[1 0 0]*ETAE;
sys(2)=[0 1 0]*ETAE;
sys(3)=[0 0 1]*ETAE;
sys(4)=[1 0 0]*dX1;
sys(5)=[0 1 0]*dX1;
sys(6)=[0 0 1]*dX1;
sys(7)=[1 0 0]*dX2;
sys(8)=[0 1 0]*dX2;
sys(9)=[0 0 1]*dX2;
sys(10)=[1 0 0]*Fos;
sys(11)=[0 1 0]*Fos;
sys(12)=[0 0 1]*Fos;
sys(13)=[1 0 0]*Fog;
sys(14)=[0 1 0]*Fog;
sys(15)=[0 0 1]*Fog;



